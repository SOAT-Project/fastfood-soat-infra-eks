name: "Deploy"

on:
  push:
    branches:
      - develop
      - release
      - main

permissions:
  id-token: write
  contents: read

jobs:
  
  set_environment:
    runs-on: ubuntu-latest
    outputs:
      mapped_environment: ${{ steps.branch_map.outputs.environment }}

    steps:
      - id: branch_map
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          ENVIRONMENT=""

          case "$BRANCH_NAME" in
            "develop")
              ENVIRONMENT="dev"
              ;;
            "release")
              ENVIRONMENT="hom"
              ;;
            "main")
              ENVIRONMENT="prod"
              ;;
            *)
              echo "Branch $BRANCH_NAME nÃ£o mapeada para um ambiente de deploy. Abortando."
              exit 1
              ;;
          esac

          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
          echo "Ambiente mapeado: $ENVIRONMENT"

  deploy:
    needs: set_environment
    if: success() && needs.set_environment.outputs.mapped_environment != ''
    uses: ./.github/workflows/terraform.yaml
    with: 
      environment: ${{ needs.set_environment.outputs.mapped_environment }}
    secrets:
      aws-assume-role-arn: ${{ secrets.AWS_GITHUB_ACTIONS_ROLE_ARN }}
      aws-region: ${{ secrets.AWS_REGION }}
      aws-statefile-s3-bucket: ${{ secrets.AWS_STATEFILE_S3_BUCKET }}
      aws-lock-dynamodb-table: ${{ secrets.AWS_LOCK_DYNAMODB_TABLE }}
